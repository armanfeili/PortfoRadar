name: CD

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - main
      - master
  workflow_dispatch:

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: true

jobs:
  verify-deployment:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Wait for Railway deployment
        run: |
          echo "‚è≥ Waiting for Railway to deploy (Railway auto-deploys via GitHub integration)..."
          sleep 60

      - name: Verify deployment health
        env:
          RAILWAY_URL: ${{ secrets.RAILWAY_URL || 'https://portforadar-production.up.railway.app' }}
        run: |
          echo "üîç Checking deployment health at $RAILWAY_URL/health"
          for i in {1..12}; do
            if curl -f -s "$RAILWAY_URL/health" > /dev/null; then
              echo "‚úÖ Deployment verified - health check passed"
              exit 0
            fi
            echo "‚è≥ Attempt $i/12: Health check not ready yet, retrying in 15s..."
            sleep 15
          done
          echo "‚ö†Ô∏è Health check failed after 12 attempts"
          echo "Note: Railway auto-deploys via GitHub integration. If deployment fails, check Railway dashboard."
          exit 1
        continue-on-error: true

      - name: Deployment status
        if: always()
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            CI_STATUS="‚ö†Ô∏è Skipped (manual trigger)"
          else
            CI_STATUS="‚úÖ Passed"
          fi
          echo "üìã CD Pipeline Summary:"
          echo "  - CI Status: $CI_STATUS"
          echo "  - Railway Deployment: Triggered via GitHub integration"
          echo "  - Health Check: ${{ job.status }}"
          echo ""
          echo "üí° Railway automatically deploys when code is pushed to main."
          echo "   Monitor deployments at: https://railway.app"
